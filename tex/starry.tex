\documentclass[modern]{aastex61}

\input{stylez}

\begin{document}%\raggedbottom\sloppy\sloppypar\frenchspacing

\setlength{\abovedisplayskip}{1.5em}
\setlength{\belowdisplayskip}{1.5em}

\title{%
    \textbf{STARRY}: Analytic Occultation Light Curves
}

\author[0000-0002-0296-3826]{Rodrigo Luger}
\affil{Department~of~Astronomy, University~of~Washington, Seattle, WA}
\author{others}

\keywords{methods: analytical --- techniques: photometric}

\begin{abstract}
 Â   We derive analytical, closed form solutions for the total flux
    received from a spherical planet, moon or star during an occultation
    if the specific intensity map of the body is expressed as a
    sum of spherical harmonics. Our expressions are valid to arbitrary degree
    and may be computed recursively for speed. The formalism we develop
    here applies to the computation of stellar transit light curves,
    planetary secondary eclipse light curves, and planet-planet/planet-moon
    occultation light curves, as well as thermal (rotational) phase curves.
    We present \starry, a full photodynamical code written in \C
    and wrapped in \Python that computes these light curves. \starry also
    computes analytic derivatives of the light curves with respect to all input
    parameters for use in gradient-based inference schemes such as
    Hamiltonian monte carlo (HMC), allowing users to quickly and efficiently
    regress on observed light curves to infer properties of a celestial body's
    surface map.
\end{abstract}

% NOTE:
% Use of the Python logo permitted under the PSF Trademark Usage Policy:
%   https://www.python.org/psf/trademarks/
%
% The Mathematica logo is in the public domain:
%   https://commons.wikimedia.org/wiki/File:Mathematica_Logo.svg


% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
%
\section{Introduction}
\label{sec:intro}

Our understanding of the surface of Earth and the other planets in our Solar
System starts with the creation of maps.  Mapping the colors, compositions, and
surface features give us an understanding of the geological, hydrological,
and meteorological processes occurring that are the basis of planetary science,
including comparative planetology.  With the discovery of planets orbiting other
stars, map-making becomes a formidable task:  these planets are too distant to
facilitate high-resolution maps as we do for our own planetary suite.  One way
to overcome this drawback is to utilize the time-dependence of unresolved,
disk-integrated light from planetary bodies:  both rotational variability and
occultations yield the opportunity to constrain the presence of static variations
in the surface features of exoplanets.

The first application of time-dependent mapping to exoplanets was carried out in the
infrared with HD 189733b using both phase-variations and secondary eclipse of the
exoplanet (Knutson et al. 2007, Majeau et al. 2012, de Wit et al. 2012).  These
yielded crude constraints on the monopole and dipole components of the thermal
emission from the thick, windy atmosphere of this giant planet.  With the subsequent
discovery of smaller planets that are perhaps rocky, opened the possibility of
applying the mapping technique to exoplanets with solid or liquid surfaces, and
perhaps long-lived surface features [Cowan et al. application to Earth as an exoplanet;
TRAPPIST-1 PPOs; Fujita et al.]

Phase curves are a subset of rotational light curves when a planet is tidally locked.
\todo{intro}

% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

We provide links to \Python code (\pythonlogo{}) to reproduce all
figures in this paper, as well as links to \Mathematica scripts
(\mathematicalogo{}) and PDFs (\pdflogo{}) containing proofs and derivations
of the principal
equations. For convenience, Table~\ref{tab:symbols} at the end lists
all the symbols used
in the paper, with references to the equations defining them.

% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
%\pagebreak
\section{Spherical harmonics}
\label{sec:spharm}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

The orthonormalized real spherical harmonics $Y_{lm}(\theta,\phi)$ of degree $l$
and order $m$ with the Condon-Shortley phase factor \citep[e.g.][]{Varshalovich1988}
are defined in spherical coordinates as
%
\begin{align}
    \label{eq:ylmtp}
    Y_{lm}(\theta, \phi) =
    \begin{cases}
        \bar{P}_{lm}(\cos\theta)\cos(m\phi) & \qquad m \geq 0 \\
        \bar{P}_{l|m|}(\cos\theta)\sin(|m|\phi) & \qquad m < 0 \quad,
    \end{cases}
\end{align}
%
where $\bar{P}_{lm}$ are the normalized associated Legendre functions.
On the
surface of the unit sphere, we have
%
\begin{align}
    \label{eq:xyz}
    \x &= \sin\theta \cos\phi \nonumber \\
    \y &= \sin\theta \sin\phi \nonumber \\
    \z &= \cos\theta \quad.
\end{align}
%
The observer is located along the $z$-axis at $z = -\infty$ such
that the projected disk of the body sits at the origin on the $xy$-plane with $\xhat$ to
the right and $\yhat$ up.
%
Expanding Equation~(\ref{eq:ylmtp}) using the multiple angle formula, we obtain
%
\begin{align}
    \label{eq:ylm0}
    Y_{lm}(\x, \y , \z) =
    \left(\frac{1}{\sqrt{1 - \z^2}}\right)^{|m|}
    \begin{dcases}
        \bar{P}_{lm}(\z)
        \sum_{j\, \mathrm{even}}^{m}
        \left(-1\right)^\frac{j}{2}
        \binom{m}{j}
        \x^{m - j}
        \y^j
         & \qquad m \geq 0
         %
         \\[1em]
         %
        \bar{P}_{l|m|}(\z)
        \sum_{j\, \mathrm{odd}}^{|m|}
        \left(-1\right)^\frac{j-1}{2}
        \binom{|m|}{j}
        \x^{|m| - j}
        \y^j
        & \qquad m < 0 \quad ,
    \end{dcases}
\end{align}
%
where $\binom{\bigdot}{\bigdot}$ is the binomial
coefficient. The normalized associated Legendre functions are defined as
%
\begin{align}
    \label{eq:plm}
    \bar{P}_{lm}(\z) &= A_{lm} \left(\sqrt{1-\z^2}\right)^m
                       \frac{\dd^m}{\dd \z^m}
                       \left[
                       \frac{1}{2^l l!}
                       \frac{\dd^l}{\dd \z^l}
                       \left(
                       \z^2 - 1
                       \right)^l
                       \right] \quad,
\end{align}
%
where
%
\begin{align}
    \label{eq:alm}
    A_{lm} = \sqrt{\frac{(2 - \delta_{m0})(2l + 1)(l - m)!}{4\pi(l + m)!}}
             \quad.
\end{align}
%
Expanding out the $\z$ derivatives, we obtain
%
\begin{align}
    \label{eq:plm_exp}
    \bar{P}_{lm}(\z) &= A_{lm} \left(\sqrt{1-\z^2}\right)^m\sum_{k=0}^{l-m}
                       \frac{2^l \left(\frac{l + m + k - 1}{2}\right)!}
                            {k!(l-m-k)!
                             \left(\frac{-l + m + k - 1}{2}\right)!}
                       \z^k
                       \quad,
\end{align}
%
which we combine with the previous results to write
%
\begin{align}
    \label{eq:ylmxyz}
    Y_{lm}(\x, \y , \z) &=
    \begin{dcases}
        \sum_{j\, \mathrm{even}}^m\sum_{k=0}^{l-m}
        \left(-1\right)^{\frac{j}{2}}
        A_{lm}
        B_{lm}^{jk}
        \x^{m - j}
        \y^j
        \z^k
        \qquad & m \ge 0 \\
        %
        \sum_{j\, \mathrm{odd}}^{|m|}\sum_{k=0}^{l-|m|}
        \left(-1\right)^{\frac{j-1}{2}}
        A_{l|m|}
        B_{l|m|}^{jk}
        \x^{|m| - j}
        \y^j
        \z^k
        \qquad & m < 0
    \end{dcases}
    \mathematica{Y}
\end{align}
%
where
%
\begin{align}
    \label{eq:blmjk}
    B_{lm}^{jk} =
    \frac{2^l m! \left(\frac{l + m + k - 1}{2}\right)!}
         {j! k! (m - j)! (l - m - k)!
          \left(\frac{-l + m + k - 1}{2}\right)!} \quad.
\end{align}
%
\begin{figure}[t!]
    \begin{centering}
    \includegraphics[width=\linewidth]{figures/ylms.pdf}
    \caption{\label{fig:ylms}
             \animation{ylms}
             The real spherical harmonics up to degree $l = 5$ computed from
             Equation~(\ref{eq:ylmxy}). In these plots, the $x$-axis points
             to the right,
             \python{ylms}
             the $y$-axis points up, and the $z$-axis points
             out of the page. Click on the link on the right to view an
             animated version.}
    \end{centering}
\end{figure}
%
Since we are confined to the surface of the unit sphere, we have
$\z = \sqrt{1 - \x^2 - \y^2}$ and we may expand $\z^k$ using
the binomial theorem:
%
\begin{align}
    \z^{k} &= (1 - \x^2 - \y^2)^\frac{k}{2} \nonumber \\[0.5em]
          &=
          \begin{dcases}
              \sum_{p\,\mathrm{even}}^{k}
              \sum_{q\,\mathrm{even}}^p
              (-1)^\frac{p}{2}
              C_{pq}^{k}
              \x^{p-q} \y^{q}
              \qquad & k\,\mathrm{even} \\
              %
              \sum_{p\,\mathrm{even}}^{k - 1}
              \sum_{q\,\mathrm{even}}^p
              (-1)^\frac{p}{2}
              C_{pq}^{k-1}
              \x^{p-q} \y^{q} \sqrt{1 - \x^2 - \y^2}
              \qquad & k\,\mathrm{odd} \quad,
          \end{dcases}
          \label{eq:zk}
\end{align}
%
where
%
\begin{align}
    \label{eq:ckpq}
    C_{pq}^{k} =
    \frac{\left(\frac{k}{2}\right)!}{\left(\frac{q}{2}\right)!
    \left(\frac{k-p}{2}\right)! \left(\frac{p-q}{2}\right)!} \quad.
\end{align}
%
This gives us an expression for the spherical harmonics $Y_{lm}$
as a function of $\x$ and $\y$ only:
%
\begin{align}
    \label{eq:ylmxy}
    \mathematica{Y}
    Y_{lm}(\x, \y) &=
    \begin{dcases}
        \!\begin{aligned}%[b]
            &
                \sum_{j\, \mathrm{even}}^m
                \sum_{k\, \mathrm{even}}^{l-m}
                \sum_{p\,\mathrm{even}}^{k}
                \sum_{q\,\mathrm{even}}^p
                \left(-1\right)^{\frac{j+p}{2}}
                A_{lm}
                B_{lm}^{jk}
                C_{pq}^{k}
                \x^{m - j + p - q}
                \y^{j + q}
            \, + \\
            &
                \sum_{j\, \mathrm{even}}^m
                \sum_{k\, \mathrm{odd}}^{l-m}
                \sum_{p\,\mathrm{even}}^{k - 1}
                \sum_{q\,\mathrm{even}}^p
                \left(-1\right)^{\frac{j+p}{2}}
                A_{lm}
                B_{lm}^{jk}
                C_{pq}^{k - 1}
                \x^{m - j + p - q}
                \y^{j + q}
                \z
       \end{aligned}
       &
       \quad m \ge 0 \\
       %
       %
       \\
       %
       %
       \!\begin{aligned}%[b]
           &
               \sum_{j\, \mathrm{odd}}^{|m|}
               \sum_{k\, \mathrm{even}}^{l-|m|}
               \sum_{p\,\mathrm{even}}^{k}
               \sum_{q\,\mathrm{even}}^p
               \left(-1\right)^{\frac{j+p-1}{2}}
               A_{l|m|}
               B_{l|m|}^{jk}
               C_{pq}^{k}
               \x^{|m| - j + p - q}
               \y^{j + q}
           \, + \\
           &
               \sum_{j\, \mathrm{odd}}^{|m|}
               \sum_{k\, \mathrm{odd}}^{l-|m|}
               \sum_{p\,\mathrm{even}}^{k - 1}
               \sum_{q\,\mathrm{even}}^p
               \left(-1\right)^{\frac{j+p-1}{2}}
               A_{l|m|}
               B_{l|m|}^{jk}
               C_{pq}^{k - 1}
               \x^{|m| - j + p - q}
               \y^{j + q}
               \z
      \end{aligned}
      &
      \quad m < 0
   \end{dcases}
    %
\end{align}
%
where $\z = \z(\x, \y) = \sqrt{1 - \x^2 - \y^2}$.

% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
%\pagebreak
\section{Surface map vectors}
\label{sec:vectors}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

We represent a surface map as a vector $\bvec{y}$ of spherical harmonic
coefficients such that the specific intensity at the point
$(\x, \y)$ may be written
%
\begin{align}
    \label{eq:I}
    I(\x, \y) = \ybasis^\mathsf{T} (\x, \y) \, \bvec{y}
    \quad,
\end{align}
%
where $\ybasis$ is the basis of spherical harmonics,
arranged in increasing degree and order:
%
\begin{align}
    \label{eq:by}
    \ybasis =
    \begin{pmatrix}
        Y_{0, 0} &
        Y_{1, -1} & Y_{1, 0} & Y_{1, 1} &
        Y_{2, -2} & Y_{2, -1} & Y_{2, 0} & Y_{2, 1} & Y_{2, 2} &
        \cdot\cdot\cdot
    \end{pmatrix}^\mathsf{T}
    \quad,
\end{align}
%
where $Y_{l, m} = Y_{l, m}(\x, \y)$ are given by \eq{ylmxy}.
For reference, in this basis the coefficient of the spherical harmonic
$Y_{l, m}$ is located at the index
%
\begin{align}
    \label{eq:n}
    n = l^2 + l + m
\end{align}
%
of the vector $\bvec{y}$. Conversely, the coefficient at index $n$
of $\bvec{y}$ corresponds
to the spherical harmonic of degree and order given by
%
\begin{align}
    \label{eq:lm}
    l &= \floor*{\sqrt{n}} \nonumber \\
    m &= n - \floor*{\sqrt{n}}^2 - \floor*{\sqrt{n}}
    \quad.
\end{align}
%

% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
%\pagebreak
\section{Rotation}
\label{sec:rotation}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

% ------------------------------------------------------------------------------
\subsection{Euler angles}
\label{sec:euler}
% ------------------------------------------------------------------------------

Defining a map as a vector of spherical harmonic coefficients makes it
straightforward to compute the projection of the map under arbitrary rotations
of the body via a rotation matrix $\bvec{R}$:
%
\begin{align}
    \label{eq:rotation}
    \bvec{y'} = \bvec{R} \, \bvec{y}
\end{align}
%
where $\bvec{y'}$ are the spherical harmonic coefficients of the rotated map.
\citet{AlvarezCollado1989} derived expressions for the rotation matrices for
the real spherical harmonics of a given degree $l$ from the corresponding
complex rotation matrices \citep{Steinborn1973}:
%
\begin{align}
    \label{eq:rl}
    \bvec{R}^l = \bvec{U}^{-1} \bvec{D}^l \bvec{U}
\end{align}
%
where
%
\begin{align}
    \label{eq:dl}
    \bvec{D}^l_{m,m'} &= \mathrm{e}^{-\ii (\alpha m' + \gamma m)}
                       (-1)^{m' + m}
                       \sqrt{
                            (l - m)! (l + m)! (l - m')! (l + m')!
                       }
                       \nonumber \\
                       & \phantom{=}
                       \times
                       \sum_k (-1)^k
                              \frac{
                                \cos\left(\frac{\beta}{2}\right)^{2l + m - m' - 2k}
                                \sin\left(\frac{\beta}{2}\right)^{-m + m' + 2k}
                              }{
                                k! (l + m - k)! (l - m' - k)! (m' - m + k)!
                              }
\end{align}
%
is the rotation matrix for the complex spherical harmonics of degree $l$ and
%
\begin{equation}
    \label{eq:U}
    \setstackgap{L}{1.25\baselineskip}
    \fixTABwidth{T}
    \bvec{U} =
    \frac{1}{\sqrt{2}}
        \parenMatrixstack{
            \quad\quad\, \ddots \, \quad\quad\quad\quad
                   &     &     &     &          &     &     &     & \Ddots \\
                   & \ii &     &     &          &     &     &  1  &        \\
                   &     & \ii &     &          &     &  1  &     &        \\
                   &     &     & \ii &          &  1  &     &     &        \\
                   &     &     &     & \sqrt{2} &     &     &     &        \\
                   &     &     & \ii &          & -1  &     &     &        \\
                   &     & -\ii&     &          &     &  1  &     &        \\
                   & \ii &     &     &          &     &     & -1  &        \\
            \Ddots &     &     &     &          &     &     &     & \ddots
        }\quad.
\end{equation}
%
describes the transformation from complex to real spherical harmonics. In
\eq{dl} above, $\alpha$, $\beta$, and $\gamma$ are the (proper) Euler angles
for rotation in the $z-y-z$ convention.
%
To obtain a rotation matrix for an arbitrary vector $\bvec{y}$ with spherical
harmonics of different orders up to $l = l_\mathrm{max}$, we define the
block-diagonal matrix $\bvec{R}$:
%
\begin{equation}
    \label{eq:rblockdiag}
    \setstackgap{L}{1.25\baselineskip}
    \fixTABwidth{T}
    \bvec{R} =
        \parenMatrixstack{
            \quad\quad \, \bvec{R}^0 \, \quad\quad
                       &            &            &            &  \\
                       & \bvec{R}^1 &            &            &  \\
                       &            & \bvec{R}^2 &            &  \\
                       &            &            & \bvec{R}^3 &  \\
                       &            &            &            & \ddots
        }\quad.
    \mathematica{R}
\end{equation}
%
Rotation of $\bvec{y}$ by the Euler angles $\alpha$, $\beta$, and $\gamma$
is performed via \eq{rotation} with $\bvec{R}$ given by \eq{rblockdiag}.

% ------------------------------------------------------------------------------
\subsection{Axis-angle}
\label{sec:axisangle}
% ------------------------------------------------------------------------------

It is often more convenient to define a rotation by an axis $\bvec{u}$
and an angle $\theta$ of rotation about that axis. Given a unit vector
$\bvec{u}$ and an angle $\theta$, we can find the corresponding Euler
angles by comparing the 3-dimensional Cartesian rotation matrices for
both systems,
%
\begin{equation}
    \label{eq:rotP}
    \setstackgap{L}{1.25\baselineskip}
    \fixTABwidth{T}
    \mathbf{P} =
        \parenMatrixstack{
        c_\theta + u_x^2 \left(1 - c_\theta\right)
        &
        u_x u_y \left(1 - c_\theta\right) - u_z s_\theta
        &
        u_x u_z \left(1 - c_\theta\right) + u_y s_\theta
        \\
        u_y u_x \left(1 - c_\theta\right) + u_z s_\theta
        &
        c_\theta + u_y^2\left(1 - c_\theta\right)
        &
        u_y u_z \left(1 - c_\theta\right) - u_x s_\theta
        \\
        \quad\,\, u_z u_x \left(1 - c_\theta\right) - u_y s_\theta \,\,\quad\,
        &
        u_z u_y \left(1 - c_\theta\right) + u_x s_\theta
        &
        c_\theta + u_z^2\left(1 - c_\theta\right)
        }
\end{equation}
%
for axis-angle rotations and
%
\begin{equation}
    \label{eq:rotQ}
    \setstackgap{L}{1.25\baselineskip}
    \fixTABwidth{T}
    \mathbf{Q} =
        \parenMatrixstack{
        c_\alpha c_\beta c_\gamma - s_\alpha s_\gamma
        &
        -c_\gamma s_\alpha - c_\alpha c_\beta s_\gamma
        &
        c_\alpha s_\beta
        \\
        c_\alpha s_\gamma + c_\beta c_\gamma s_\alpha
        &
        c_\alpha c_\gamma - c_\beta s_\alpha s_\gamma
        &
        s_\alpha s_\beta
        \\
        -c_\gamma s_\beta
        &
        s_\beta s_\gamma
        &
        c_\beta
        }\quad,
\end{equation}
%
for Euler rotations,
where $c_{\bigdot} \equiv \cos(\cdot)$
and $s_{\bigdot} \equiv \sin(\cdot)$.
Comparison of the two matrices gives us expressions for the Euler
angles in terms of $\bvec{u}$ and $\theta$:
%
\begin{align}
    \label{eq:eulerangles}
    \begin{matrix}
        \cos\alpha = \frac{P_{0,2}}{\sqrt{P_{0,2}^2 + P_{1,2}^2}}
        & & & &
        \cos\beta = P_{2,2}
        & & & &
        \cos\gamma = -\frac{P_{2,0}}{\sqrt{P_{2,0}^2 + P_{2,1}^2}}
        \\
        \sin\alpha = \frac{P_{1,2}}{\sqrt{P_{0,2}^2 + P_{1,2}^2}}
        & & & &
        \sin\beta = \sqrt{1 - P_{2,2}^2}
        & & & &
        \sin\gamma = \frac{P_{2,1}}{\sqrt{P_{2,0}^2 + P_{2,1}^2}}
    \end{matrix}
    \quad.
    \mathematica{R}
\end{align}
%
Thus, given a spherical harmonic vector $\bvec{y}$, we can calculate
how it transforms under rotation by an angle $\theta$ about an axis $\bvec{u}$
by first computing the Euler angles (Equation~\ref{eq:eulerangles}) and using
those to construct the spherical harmonic rotation matrix
(Equation~\ref{eq:rblockdiag}).

% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
%\pagebreak
\section{Change of basis}
\label{sec:basis}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

% ------------------------------------------------------------------------------
\subsection{Polynomial basis}
\label{sec:polybasis}
% ------------------------------------------------------------------------------

In order to compute the occultation light curve for a body with a given surface
map $\bvec{y}$, it is convenient to first find its polynomial representation
$\bvec{p}$, which we express as a vector of coefficients in the
polynomial basis $\pbasis$:
%
\begin{align}
    \label{eq:bp}
    \pbasisn &=
    \begin{dcases}
        \x^\frac{\mu}{2} \y^\frac{\nu}{2} & \qquad \nu \, \mathrm{even}
        \\
        \x^\frac{\mu-1}{2} \y^\frac{\nu-1}{2} \z & \qquad \nu \, \mathrm{odd}
    \end{dcases}
    \nonumber\\[0.5em]
    \pbasis &=
    \begin{pmatrix}
        1 &
        \x & \z & \y &
        \x^2 & \x\z & \x\y & \y\z & \y^2 &
        \cdot\cdot\cdot
    \end{pmatrix}^\mathsf{T}
    \quad,
    \mathematica{A1}
\end{align}
%
where
%
\begin{align}
    \label{eq:munu}
    \mu &= l - m \nonumber \\
    \nu &= l + m
    \quad
\end{align}
%
with $l$ and $m$ given by \eq{lm}.
%
%
To find $\bvec{p}$ given $\bvec{y}$, we
introduce the change of basis matrix $\AOne$,
which transforms
a vector in the spherical harmonic basis $\ybasis$ to the
polynomial basis $\pbasis$:
%
\begin{align}
    \bvec{p} = \AOne \, \bvec{y}
\end{align}
%
The columns of $\AOne$ are simply the polynomial vectors
corresponding to each of the spherical harmonics in \eq{by}. From
Equations (\ref{eq:ylmxy}) and (\ref{eq:bp}), we can calculate
the first few spherical harmonics and their corresponding polynomial vectors:
%
\begin{equation}
\def\arraystretch{1.3}
\begin{array}{@{}lcccccccl@{}}
    \phantom{..}
    Y_{0,0} = \frac{1}{2\sqrt{\pi}}
    & & & & & & & &
    \bvec{p} = \frac{1}{2\sqrt{\pi}}
                  \begin{pmatrix}
                        1 & 0 & 0 & 0 & \cdot\cdot\cdot
                  \end{pmatrix}^\mathsf{T}
    %
    \\
    %
    Y_{1,-1} = \frac{\sqrt{3}}{2\sqrt{\pi}}\y
    & & & & & & & &
    \bvec{p} = \frac{1}{2\sqrt{\pi}}
                  \begin{pmatrix}
                        0 & 0 & 0 & \sqrt{3} & \cdot\cdot\cdot
                  \end{pmatrix}^\mathsf{T}
    %
    \\
    %
    \phantom{..}
    Y_{1,0} = \frac{\sqrt{3}}{2\sqrt{\pi}}\z
    & & & & & & & &
    \bvec{p} = \frac{1}{2\sqrt{\pi}}
                \begin{pmatrix}
                      0 & 0 & \sqrt{3} & 0 & \cdot\cdot\cdot
                \end{pmatrix}^\mathsf{T}
    %
    \\
    %
    \phantom{..}
    Y_{1,1} = \frac{\sqrt{3}}{2\sqrt{\pi}}\x
    & & & & & & & &
    \bvec{p} = \frac{1}{2\sqrt{\pi}}
                  \begin{pmatrix}
                        0 & \sqrt{3} & 0 & 0 & \cdot\cdot\cdot
                  \end{pmatrix}^\mathsf{T}
    %
    \\
    %
    Y_{2,-2} = \cdot\cdot\cdot
    & & & & & & & &
    \bvec{p} = \cdot\cdot\cdot
\end{array}
\end{equation}
%
From these we can construct $\AOne$. As an example, for spherical
harmonics up to degree $l_\mathrm{max} = 2$, this is
%
\begin{equation}
    \label{eq:AOne}
    \setstackgap{L}{1.25\baselineskip}
    \fixTABwidth{T}
    \AOne =
    \frac{1}{2 \sqrt{\pi }}
        \parenMatrixstack{
            1 & 0 & 0 & 0 & 0 & 0 & \sqrt{5} & 0 & 0 \\
            0 & 0 & 0 & \sqrt{3} & 0 & 0 & 0 & 0 & 0 \\
            0 & 0 & \sqrt{3} & 0 & 0 & 0 & 0 & 0 & 0 \\
            0 & \sqrt{3} & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
            0 & 0 & 0 & 0 & 0 & 0 & -\frac{3 \sqrt{5}}{2} & 0 & \frac{\sqrt{15}}{2} \\
            0 & 0 & 0 & 0 & 0 & 0 & 0 & \sqrt{15} & 0 \\
            0 & 0 & 0 & 0 & \sqrt{15} & 0 & 0 & 0 & 0 \\
            0 & 0 & 0 & 0 & 0 & \sqrt{15} & 0 & 0 & 0 \\
            0 & 0 & 0 & 0 & 0 & 0 & -\frac{3 \sqrt{5}}{2} & 0 & -\frac{\sqrt{15}}{2}
        }\quad.
    \mathematica{A1}
\end{equation}
%
As before, the specific intensity at the point $(\x, \y)$
may be computed as
%
\begin{align}
    I(\x, \y) &= \pbasis^\mathsf{T} \bvec{p} \nonumber \\
              &= \pbasis^\mathsf{T} \AOne \, \bvec{y}
    \quad.
\end{align}

% ------------------------------------------------------------------------------
%\pagebreak
\subsection{Green's basis}
\label{sec:greensbasis}
% ------------------------------------------------------------------------------
As we will see in the next section, integrating the surface map over the disk of
the body is easier if we apply one final transformation to our input vector,
rotating it into what we will refer to as the \emph{Green's basis}, $\gbasis$:
%
\begin{align}
    \label{eq:bg}
    \gbasisn &=
    \begin{dcases}
        %
        \frac{\mu+2}{2}\x^\frac{\mu}{2} \y^\frac{\nu}{2}
            & \qquad \nu \, \mathrm{even}
        \\[1em]
        %
        \z
            & \qquad l = 1, \, m = 0
        \\[1em]
        %
        3\x^{l-2}\y\z
            & \qquad \nu \, \mathrm{odd}, \,
                     \mu = 1, \,
                     l \, \mathrm{even}
        \\[1em]
        %
        \z
        \bigg(
         -\x^{l-3} + \x^{l-1} + 4\x^{l-3}\y^2
        \bigg)
         & \qquad \nu \, \mathrm{odd}, \,
                  \mu = 1, \,
                  l \, \mathrm{odd}
        \\[1em]
        %
        \z
        \bigg(
            \frac{\mu-3}{2} \x^\frac{\mu-5}{2} \y^\frac{\nu-1}{2}
            -
            \frac{\mu-3}{2} \x^\frac{\mu-5}{2} \y^\frac{\nu+3}{2}
            -
            \frac{\mu+3}{2} \x^\frac{\mu-1}{2} \y^\frac{\nu-1}{2}
        \bigg)
            & \qquad \mathrm{otherwise}
    \end{dcases}
    \nonumber\\[1.5em]
    \gbasis &=
    \begin{pmatrix}
        1 &
        2\x & \z & \y &
        3\x^2 & -3\x\z & 2\x\y & 3\y\z & \y^2 &
        \cdot\cdot\cdot
    \end{pmatrix}^\mathsf{T}
    \quad,
    \mathematica{A2}
\end{align}
%
where the values of $l$, $m$, $\mu$, and $\nu$ are given by
Equations~(\ref{eq:lm}) and (\ref{eq:munu}). Given
a polynomial vector $\bvec{p}$, the corresponding vector in
the Green's basis, $\bvec{g}$, can be found by performing another
change of basis operation:
%
\begin{align}
    \bvec{g} = \bvec{\ATwo} \, \bvec{p}
\end{align}
%
where the columns of the matrix $\ATwo$ are the Green's vectors
corresponding to each of the polynomial terms in \eq{bp}. In practice,
it is easier to express the elements of $\gbasis$ in terms
of the elements of $\pbasis$ and use those to populate the
columns of the matrix $\ATwo^{-1}$. Continuing our example
for $l_\mathrm{max} = 2$, our second change of basis matrix
is
%
\begin{equation}
    \setstackgap{L}{1.1\baselineskip}
    \fixTABwidth{T}
    \ATwo =
        \parenMatrixstack{
            \quad\quad\, 1\, \quad\quad\quad\quad & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
            0 & \frac{1}{2} & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
            0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
            0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 \\
            0 & 0 & 0 & 0 & \frac{1}{3} & 0 & 0 & 0 & 0 \\
            0 & 0 & 0 & 0 & 0 & -\frac{1}{3} & 0 & 0 & 0 \\
            0 & 0 & 0 & 0 & 0 & 0 & \frac{1}{2} & 0 & 0 \\
            0 & 0 & 0 & 0 & 0 & 0 & 0 & \frac{1}{3} & 0 \\
            0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1
        }\quad.
    \mathematica{A2}
\end{equation}
%
Given $\AOne$ and $\ATwo$, we can easily transform a spherical harmonic
vector $\bvec{y}$ to a Green's vector $\bvec{g}$:
%
\begin{align}
    \bvec{g} &= \ATwo \, \AOne \, \bvec{y} \nonumber \\
             &= \bvec{A} \, \bvec{y}
\end{align}
%
where
%
\begin{align}
    \label{eq:A}
    \bvec{A} \equiv \ATwo \, \AOne
\end{align}
%
is the full change of basis matrix. For
$l_\mathrm{max} = 2$,
%
\begin{equation}
    \mathematica{A}
    \setstackgap{L}{1.25\baselineskip}
    \fixTABwidth{T}
    \bvec{A} =
        \frac{1}{2\sqrt{\pi}}
        \parenMatrixstack{
         1 & 0 & 0 & 0 & 0 & 0 & \frac{\sqrt{5}}{2} & 0 & 0 \\
         0 & 0 & 0 & \sqrt{3} & 0 & 0 & 0 & 0 & 0 \\
         0 & 0 & \sqrt{3} & 0 & 0 & 0 & 0 & 0 & 0 \\
         0 & \frac{\sqrt{3}}{2} & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
         0 & 0 & 0 & 0 & 0 & 0 & -\frac{3 \sqrt{5}}{4} & 0 & \frac{\sqrt{15}}{2} \\
         0 & 0 & 0 & 0 & 0 & 0 & 0 & \sqrt{\frac{5}{3}} & 0 \\
         0 & 0 & 0 & 0 & \sqrt{\frac{5}{3}} & 0 & 0 & 0 & 0 \\
         0 & 0 & 0 & 0 & 0 & -\sqrt{\frac{5}{3}} & 0 & 0 & 0 \\
         0 & 0 & 0 & 0 & 0 & 0 & -\frac{3 \sqrt{5}}{4} & 0 & -\frac{\sqrt{15}}{2}
        }\quad.
\end{equation}
%
For completeness, we note that the specific intensity at a point on a map
described by the spherical harmonic vector $\bvec{y}$ is
%
\begin{align}
    \label{eq:fluxpoint}
    I(\x, \y) &= \gbasis^\mathsf{T}(\x, \y) \bvec{g} \nonumber \\
              &= \gbasis^\mathsf{T}(\x, \y) \bvec{A} \, \bvec{y}
    \quad.
\end{align}
%

% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
%\pagebreak
\section{Light curves}
\label{sec:occultations}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

% ------------------------------------------------------------------------------
\subsection{Rotational phase curves}
\label{sec:phasecurves}
% ------------------------------------------------------------------------------

Consider a body of unit radius centered at the origin, with a surface map
given by the spherical harmonic vector $\bvec{y}$ viewed at an orientation
specified by the rotation matrix $\bvec{R}$, such that
the specific intensity at a point $(\x, \y)$ on the surface is
%
\begin{align}
    I(\x, \y) &= \ybasis^\mathsf{T} (\x, \y) \bvec{R} \, \bvec{y}
    \nonumber \\
              &= \pbasis^\mathsf{T} (\x, \y) \AOne \, \bvec{R} \, \bvec{y}
    \quad
\end{align}
%
where $\pbasis$ is the polynomial basis and $\AOne$ is the corresponding
change-of-basis matrix (\S\ref{sec:polybasis}).
The total flux radiated
in the direction of the observer is obtained by integrating the specific
intensity over a region $S$ of the projected disk of the body:
%
\begin{align}
    \label{eq:phaseint}
    F &=
    \oiint I(\x, \y) \, \dd S
    \nonumber \\
    &=
    \oiint \pbasis^\mathsf{T} (\x, \y) \AOne \, \bvec{R} \, \bvec{y} \, \dd S
    \nonumber \\
    &=
    \bvec{r}^\mathsf{T} \AOne \, \bvec{R} \, \bvec{y}
    \quad,
\end{align}
%
where $\bvec{r}$ is a column vector whose $n^\mathrm{th}$ component is given by
%
\begin{align}
    \label{eq:rn}
    r_n &\equiv
      \oiint \pbasisn (\x, \y)  \, \dd S
    \quad.
\end{align}
%
When the entire disk of the body is visible (i.e., when no occultation is
occurring), this may be written
%
\begin{align}
    r_n &=
              \int_{-1}^{1}
              \int_{-\sqrt{1-\x^2}}^{\sqrt{1+\x^2}}
              \tilde{p}_n (\x, \y)
              \,
              \dd \y \, \dd \x
        \nonumber \\[1em]
        &=
        \begin{dcases}
            \frac{
                    \Gamma\left(\frac{\mu}{4} + \frac{1}{2}\right)
                    \Gamma\left(\frac{\nu}{4} + \frac{1}{2}\right)
                }{
                    \Gamma\left(\frac{\mu + \nu}{4} + 2\right)
                }
            & \qquad \frac{\mu}{2} \, \mathrm{even}, \, \frac{\nu}{2} \, \mathrm{even}
            %
            \\[1em]
            %
            \frac{\sqrt{\pi}}{2}
            \frac{
                    \Gamma\left(\frac{\mu}{4} + \frac{1}{4}\right)
                    \Gamma\left(\frac{\nu}{4} + \frac{1}{4}\right)
                }{
                    \Gamma\left(\frac{\mu + \nu}{4} + 2\right)
                }
            & \qquad \frac{\mu-1}{2} \, \mathrm{even}, \, \frac{\nu-1}{2} \, \mathrm{even}
            %
            \\[1em]
            %
            0
            & \qquad \mathrm{otherwise.}
        \end{dcases}
    \mathematica{rn}
\end{align}
%
where $\Gamma(\bigdot)$ is the gamma function.
%
\eq{phaseint} may be used to analytically compute the rotational phase curve of a body
with an arbitrary surface map. Since $\bvec{r}$ and $\bvec{A_1}$ are independent
of the map coefficients or its orientation, these may be pre-computed for
computational efficiency.

% ------------------------------------------------------------------------------
\subsection{Occultation light curves}
\label{sec:occultationflux}
% ------------------------------------------------------------------------------

Note that the specific intensity
at a point $(\x, \y)$ on the surface of a body described by the map $\bvec{y}$
may also be written as
%
\begin{align}
    I(\x, \y) &= \ybasis^\mathsf{T} (\x, \y) \bvec{R} \, \bvec{y}
    \nonumber \\
              &= \gbasis^\mathsf{T} (\x, \y) \bvec{A} \, \bvec{R} \, \bvec{y}
    \quad,
\end{align}
%
where $\gbasis$ is the Greens basis and $\bvec{A}$ is the full change of basis
matrix (\S\ref{sec:greensbasis}).
As before, the total flux radiated
in the direction of the observer is obtained by integrating the specific
intensity over a region $S$ of the projected disk of the body:
%
\begin{align}
    \label{eq:occint}
    F &=
    \oiint I(\x, \y) \, \dd S
    \nonumber \\
    &=
    \oiint \gbasis^\mathsf{T} (\x, \y) \bvec{A} \, \bvec{R} \, \bvec{y} \, \dd S
    \nonumber \\
    &= \bvec{s}^\mathsf{T} \bvec{A} \, \bvec{R} \, \bvec{y} \,
      \quad,
\end{align}
%
where $\bvec{s}$ is a column vector whose $n^\mathrm{th}$ component is given by
%
\begin{align}
    \label{eq:sndef}
    s_n &\equiv
      \oiint \gbasisn (\x, \y)  \, \dd S
    \quad.
\end{align}
%
This time, suppose the body is
occulted by another body of radius $r$ centered at the point $(x_o, y_o)$,
so that the surface $S$ over which the integral is taken
is a function of $r$, $x_o$, and $y_o$.
In general, the integrals in \eq{sndef} are
difficult (and often impossible) to compute directly.
%
One way to simplify the problem is to first perform a rotation through an angle
%
\begin{align}
    \label{eq:zrot}
    \omega = \frac{\pi}{2} - \mathrm{arctan2}(y_o, x_o)
\end{align}
%
about the $z$-axis ($\bvec{u} = \left[0, 0, 1\right]$)
so that the occultor lies along the
$+y$-axis, with its center located a distance $b = \sqrt{x_o^2 + y_o^2}$
from the origin (see Figure~\ref{fig:geometry}).
%
In this rotated frame, the limits of integration (the two points of intersection
between the occultor and the occulted body, should they exist)
are symmetric about the $y$-axis.
If we define $\phi \in [-\nicefrac{\pi}{2}, \, \nicefrac{\pi}{2}]$
as the angular position of the right hand side intersection point
relative to the occultor center, measured counter-clockwise
from the $+x$ direction, the arc of the occultor that overlaps the occulted
body extends from $\pi - \phi$ to $2\pi + \phi$ (see the Figure).
Similarly, defining $\lambda \in [-\nicefrac{\pi}{2}, \, \nicefrac{\pi}{2}]$
as the angular position of the same point relative to the origin, the
arc of the portion of the occulted body that is visible during the occultation
extends from $\pi - \lambda$ to $2\pi + \lambda$ (see the Figure).
%
For future reference, it can be shown that
%
\begin{align}
    \label{eq:phi}
    \phi &=
    \begin{dcases}
        \arcsin\left({\frac{1 - r^2 - b^2}{2br}}\right)
                                                & \qquad |1 - r| < b < 1 + r \\
        \frac{\pi}{2}                           & \qquad b \le 1 - r
    \end{dcases}
    \mathematica{philam} \\
\intertext{and}
    \label{eq:lambda}
    \lambda &=
    \begin{dcases}
        \arcsin\left(\frac{1 - r^2 + b^2}{2b}\right)
                                                & \qquad |1 - r| < b < 1 + r \\
        \frac{\pi}{2}                           & \qquad b \le 1 - r
        \quad,
    \end{dcases}
    \mathematica{philam}
\end{align}
%
The case $b \le 1 - r$ corresponds to an occultation during which the occultor
is fully within the planet disk, so no points of intersection exist.
In this case,
we define $\phi$ such that the arc from $\pi - \phi$ to $2\pi + \phi$ spans the
entire circumference of the occultor, and $\lambda$ such that the arc
from $\pi - \lambda$ to $2\pi + \lambda$ spans the
entire circumference of the occulted body.
Note that if $b \ge 1 + r$, no occultation occurs and the flux may
be computed as in \S\ref{sec:phasecurves}, while
if $b \le r - 1$, the entire disk of the body is occulted and the total flux
is zero.

%

The second trick we employ to solve \eq{sn} is to use
Green's theorem to express the surface integral of $\gbasis_n$ as the
line integral of a vector function $\bvec{G}_n$ along the boundary of
the same surface \citep{Pal2012}:
%
\begin{align}
    \label{eq:greens}
    s_n &=
    \oiint \gbasisn (\x, \y) \, \dd S
    =
    \oint \bvec{G}_n (\x, \y) \cdot \dd \bvec{r}
    \quad
\end{align}
%
where $\bvec{G}_n (\x, \y) = {G_n}_x (\x, \y) \, \xhat + {G_n}_y (\x, \y) \, \yhat$ is
chosen such that
%
\begin{align}
    \label{eq:DGg}
    \bvec{D} \wedge \bvec{G}_n = \gbasisn(\x, \y)
    \quad.
\end{align}
%
The operation $\bvec{D} \wedge \bvec{G}_n$ denotes the
\emph{exterior derivative} of $\bvec{G}_n$. In two-dimensional Cartesian
coordinates, it is given by
%
\begin{align}
    \label{eq:extderiv}
    \bvec{D} \wedge \bvec{G}_n &\equiv \frac{\dd {G_n}_y}{\dd \x}
                                   - \frac{\dd {G_n}_x}{\dd \y} \quad.
\end{align}
%
%
Thus, in order to compute $s_n$ in \eq{greens}, we must (1) apply a rotation
to our map $\bvec{y}$ to align the occultor with the $+y$-axis;
(2) find a vector function
$\bvec{G}_n$ whose exterior derivative is the $n^\mathrm{th}$ component of the
vector basis $\gbasis$ (Equation~\ref{eq:bg}); and
(3) integrate it along the boundary of the visible portion of the occulted
body's surface. In general, for an occultation involving two bodies,
this boundary consists of two arcs: a segment of the circle bounding the
occultor (thick red curve in Figure~\ref{fig:geometry}),
and a segment of the circle bounding the occulted body (thick black curve
in Figure~\ref{fig:geometry}).
%
If we happen to know $\bvec{G}_n$, the integral in \eq{greens} is just
%
\begin{align}
    \label{eq:sn}
    s_n &= \mathcal{Q}(\bvec{G}_n) - \mathcal{P}(\bvec{G}_n)
    \quad,
\end{align}
%
where, as in \citet{Pal2012}, we define the \emph{primitive integrals}
%
\begin{align}
    \label{eq:primitiveP}
    \mathcal{P}(\bvec{G}_n) &=
    \int\displaylimits_{\pi-\phi}^{2\pi + \phi}
        \big[ {G_n}_y(r c_\varphi, b + r s_\varphi) c_\varphi -
              {G_n}_x(r c_\varphi, b + r s_\varphi) s_\varphi \big] r \dd \varphi
    \\
    %
\intertext{and}
    %
    \label{eq:primitiveQ}
    \mathcal{Q}(\bvec{G}_n) &=
    \int\displaylimits_{\pi-\lambda}^{2\pi + \lambda}
        \big[ {G_n}_y(c_\varphi, s_\varphi) c_\varphi -
              {G_n}_x(c_\varphi, s_\varphi) s_\varphi \big] \dd \varphi
    \quad,
\end{align}
%
%
where, as before,
$c_\varphi \equiv \cos \varphi$
and
$s_\varphi \equiv \sin \varphi$
and we used the fact that along the arc of a circle,
%
\begin{align}
    \label{eq:dr}
    \dd \bvec{r} &= -r s_\varphi \, \dd \varphi \, \xhat +
                     r c_\varphi \, \dd \varphi \, \yhat
    \quad.
\end{align}
%
In Equations~(\ref{eq:primitiveP}) and (\ref{eq:primitiveQ}), $\mathcal{P}(\bvec{G}_n)$
is the line integral along the arc of the occultor
and $\mathcal{Q}(\bvec{G}_n)$ is the line integral along the arc of the occulted
body.

%
%
\begin{figure}[p!]
    \begin{centering}
    \includegraphics[width=\linewidth]{figures/geometry.pdf}
    \caption{\label{fig:geometry}
             \python{geometry}
             Geometry of the occultation problem.
             The occulted body is centered
             at the origin and has unit radius, while the occultor
             is centered at $(x_o, y_o)$ and has radius $r$. We first rotate
             the two bodies about the origin through an angle
             $\theta = \nicefrac{\pi}{2} - \mathrm{arctan2}(y_o, x_o)$
             so the problem is symmetric about the $y$-axis. In this frame,
             the occultor is located at $(0, b)$, where
             $b = \sqrt{x_o^2 + y_o^2}$ is the impact parameter.
             The arc of the occultor
             that overlaps the occulted body (thick red curve) now extends from
             $\pi - \phi$ to $2\pi + \phi$, measured from the center of the
             occultor.
             The arc of the occulted body that is visible during
             the occultation (thick black curve) extends from
             $\pi - \lambda$ to $2\pi + \lambda$, measured from the origin.
             These are the curves along which the primitive integrals
             (Equations~\ref{eq:primitiveP} and \ref{eq:primitiveQ}) are evaluated.
             The angles $\phi$ and $\lambda$ are given by
             Equations~(\ref{eq:phi}) and (\ref{eq:lambda})
             and extend from $-\nicefrac{\pi}{2}$ to $\nicefrac{\pi}{2}$. When
             the occultor is completely within the disk of the occulted body,
             we define $\phi = \lambda = \nicefrac{\pi}{2}$.
             }
    \end{centering}
\end{figure}
%
%

As cumbersome as the Green's basis (Equation~\ref{eq:bg}) may appear, the reason
we introduced it is that its anti-exterior derivatives are conveniently simple.
It can be easily shown that one possible solution to \eq{DGg} is
%
\begin{align}
    \label{eq:Gn}
    \bvec{G}_n (\x, \y) &=
    \begin{dcases}
        %
        \x^{\frac{\mu + 2}{2}}
        \y^{\frac{\nu}{2}}
        \,\yhat
            & \qquad \nu \, \mathrm{even}
        \\[1em]
        %
        \frac{1-z^3}{3(1-z^2)}(-\y \, \xhat + \x \, \yhat)
            & \qquad l = 1, \, m = 0
        \\[1em]
        %
        \x^{l-2}
        \z^3
        \,\xhat
            & \qquad \nu \, \mathrm{odd}, \,
                     \mu = 1, \,
                     l \, \mathrm{even}
        \\[1em]
        %
        \x^{l-3}
        \y
        \z^3
        \,\xhat
         & \qquad \nu \, \mathrm{odd}, \,
                  \mu = 1, \,
                  l \, \mathrm{odd}
        \\[1em]
        %
        \x^{\frac{\mu-3}{2}}
        \y^{\frac{\nu-1}{2}}
        \z^3
        \,\yhat
            & \qquad \mathrm{otherwise,}
    \end{dcases}
    \mathematica{G}
\end{align}
%
where $l$ and $m$ are given by \eq{lm} and $\mu$ and $\nu$ are given by
\eq{munu}. Solving the occultation problem is therefore a matter of
evaluating the primitive integrals of $\bvec{G}_n$
(Equations~\ref{eq:primitiveP} and \ref{eq:primitiveQ}).
The solutions are in general tedious, but
they are all analytic, involving sines, cosines, and complete elliptic integrals.
In the Appendix we derive recurrence
relations to quickly compute these. We note, in particular, that all
solutions involve complete elliptic integrals of the \emph{same} argument,
so that the elliptic integrals need only be evaluated once for a map
of arbitrary degree, greatly improving the evaluation speed and the
scalability of the problem to high order.

% ------------------------------------------------------------------------------
\subsection{Summary}
\label{sec:summary}
% ------------------------------------------------------------------------------

Here we briefly summarize how to analytically compute the flux during
an occultation of a body whose specific intensity profile is described
by a sum of spherical harmonics. Given a body of unit radius with a
surface map described by the vector of spherical harmonic coefficients
$\mathbf{y}$ (Equation~\ref{eq:by}), occulted by another body of radius $r$
centered at the point $(x_o, y_o)$, we must:
%
\begin{enumerate}
    \item Compute the rotation matrix $\bvec{R}$ to rotate the map to the correct
          viewing orientation, which may be
          specified by the Euler angles $\alpha$, $\beta$, and $\gamma$
          (\S\ref{sec:euler}) or by an axis $\bvec{u}$ and an angle $\theta$
          (\S\ref{sec:axisangle}).
    \item Compute the rotation matrix $\bvec{R'}$ to rotate the map
          by an angle $\omega$ about the $+z$-axis
          (Equation~\ref{eq:zrot}) so the center of the occultor is a
          distance $b = \sqrt{x_o^2 + y_o^2}$ along the $+y$-axis
          from the center of the occulted body.
    \item Compute the change-of-basis matrix $\bvec{A}$ (\S\ref{sec:basis}) to
          convert our vector of spherical harmonic coefficients to a vector
          of polynomial coefficients in the Green's basis
          (Equation~\ref{eq:bg}). Since $\bvec{A}$ is the same for all
          occultations, this matrix may be pre-computed to improve
          computational speed.
    \item Compute the solution vector $\bvec{s}$ (Equation~\ref{eq:sn}), with
          $\mathcal{P}(\bvec{G}_n)$ and $\mathcal{Q}(\bvec{G}_n)$ given by
          Equations~(\ref{eq:PGnI}) and (\ref{eq:QGnI}). Note that $s_2$
          is special and must be computed separately (Equation~\ref{eq:s2}).
\end{enumerate}
%
Given these quantities, the total flux during an occultation is then just
%
\begin{equation}
    \label{eq:starry}
    \boxed{
        %\large
        F = \bvec{s}^{\boldsymbol{\mathsf{T}}} \bvec{A} \, \bvec{R'} \, \bvec{R} \, \bvec{y}
        }
    \quad.
\end{equation}   % This is about the nerdiest pun I've ever seen
% (with the exception "It's amazing that 230-220 x 1/2 = 5!")


% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
%\pagebreak
\section{The \textbf{STARRY} code package}
\label{sec:starrycode}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

The \starry code package provides code to analytically
compute light curves for celestial bodies using the formalism developed
in this paper. \starry is coded in \C for speed and wrapped
in \Python for quick and easy light curve calculations. The
code may be installed by running the following in a terminal:
%
\begin{lstlisting}[language=bash]
git clone https://github.com/rodluger/starry.git
cd starry
python setup.py develop
\end{lstlisting}
%
To begin using \starry, execute the following in a \Python environment:
%
\begin{lstlisting}[language=Python]
from starry import Map
\end{lstlisting}
%

% ------------------------------------------------------------------------------
\subsection{Creating a map}
\label{sec:starrymap}
% ------------------------------------------------------------------------------

A \starry map is a vector of spherical harmonic coefficients, indexed by
increasing degree and order, as in \eq{by}. We can create a map of
spherical harmonics up to degree $l_\mathrm{max} = 5$ by typing
%
\begin{lstlisting}[language=Python,firstnumber=last]
m = Map(5)
\end{lstlisting}
%
By default, all coefficients are set to zero.
Say our surface map is given by the function
%
\begin{align}
    \label{eq:ylm_code_example}
    I(\x, \y) &= -2 Y_{5,-3}(\x, \y) + 2 Y_{5,0}(\x, \y) + Y_{5,4}(\x, \y)
    \quad.
\end{align}
%
To instantiate this map, we set the corresponding coefficients in \textsf{y}:
%
\begin{lstlisting}[language=Python,firstnumber=last]
m[5, -3] = -2
m[5, 0] = 2
m[5, 4] = 1
\end{lstlisting}
%
The map may be quickly visualized by calling
%
\begin{lstlisting}[language=Python,firstnumber=last]
m.show()
\end{lstlisting}
%
or
%
\begin{lstlisting}[language=Python,firstnumber=last]
m.animate(u=[0, 1, 0])
\end{lstlisting}
%
where \textsf{u} defines the axis of rotation for the animation.
Rotation of this map about $\xhat$ yields\python{smiley}
%
\begin{center}
    \includegraphics[width=0.85\linewidth]{figures/smiley.pdf}
\end{center}
%

Alternatively, users may provide the path to an image file of the
surface map on a rectangular latitude-longitude grid or a ring-ordered
\textsf{Healpix} map array:
%
\begin{lstlisting}[language=Python,firstnumber=last]
m.load_image("/path/to/image.jpg")
\end{lstlisting}
%
or
%
\begin{lstlisting}[language=Python,firstnumber=last]
m.load_healpix(array)
\end{lstlisting}
%
In both cases, \starry uses the \textsf{map2alm()} function
of the \textsf{healpy} package to find the expansion of the map in
terms of spherical harmonics. Keep in mind that if the image contains very dark
pixels (with \textsf{RGB} values close to zero), its spherical harmonic
expansion may lead to regions with \emph{negative} specific intensity, which
is of course unphysical.

In Figure~\ref{fig:earth} we show a
simplified two-color map of the cloudless Earth and its corresponding
\starry instance for
$l_\mathrm{max} = 10$, rotated successively about $\yhat$.
%
\begin{figure}[ht!]
    \begin{centering}
    \includegraphics[width=0.8\linewidth]{figures/earth.jpg}
    \\[1em]
    \includegraphics[width=0.85\linewidth]{figures/earth.pdf}
    \caption{\label{fig:earth}
             \python{earth}
             A simplified two-color map of the cloudless Earth (top) and the
             corresponding tenth-degree spherical harmonic expansion,
             rotated about $\yhat$ (bottom).}
    \end{centering}
\end{figure}
%

% ------------------------------------------------------------------------------
\subsection{Computing rotational phase curves}
\label{sec:starryphasecurves}
% ------------------------------------------------------------------------------
%
\begin{figure}[p!]
    \begin{centering}
    \includegraphics[width=\linewidth]{figures/ylmphasecurves.pdf}
    \\[1em]
    \includegraphics[width=\linewidth]{figures/ylmlightcurves.pdf}
    \caption{\label{fig:ylmlightcurves}
             \python{ylmphasecurves}
             \emph{Top:} Phase curves for the first several spherical
             harmonics with order $m \ge 0$ rotated about the $x$-axis
             (blue) and about the $y$-axis (orange).
             Odd harmonics with $l > 1$ and harmonics with $m < 0$ are
             \python{ylmlightcurves}
             in the phase curve null space \citep{CowanFuentesHaggard2013}.
             \emph{Bottom:} Occultation light curves for the same
             set of spherical harmonics. An occultor of radius $r=0.3$
             transits the body along the $+\x$ direction at $y_o = 0.25$
             (blue) and $y_o = 0.75$ (orange). }
    \end{centering}
\end{figure}
%
Once a map is instantiated, it is easy to compute its rotational
phase curve, \textsf{F}:
%
\begin{lstlisting}[language=Python,firstnumber=last]
F = m.flux(u=u, theta=theta)
\end{lstlisting}
%
where \textsf{u} is the axis of rotation and \textsf{theta} is an array of
angles at which to compute the flux. Note that rotations performed
by \textsf{flux()} are not cumulative; instead, all angles should be specified
relative to the original, unrotated map frame.
%
In the top panel of Figure~\ref{fig:ylmlightcurves} we plot rotational phase curves
for all spherical harmonics
up to $l_\mathrm{max} = 6$ for rotation about $\xhat$ (blue curves) and $\yhat$
(orange curves). The small dots correspond to phase curves computed by numerical
evaluation of the flux on an adaptive radial mesh (see \S\ref{sec:starrybenchmarks}).
As discussed by \citet{CowanFuentesHaggard2013}, harmonics with
odd $l > 1$ and those with $m < 0$ (not plotted) are in the null space and
therefore do not exhibit rotational phase variations.

%

As a second example, we can compute the rotational phase curve of the simplified Earth model
(Figure~\ref{fig:earth}) for rotation about $\yhat$ (its actual spin axis)
by executing
%
\begin{lstlisting}[language=Python,firstnumber=last]
theta = np.linspace(0, 2 * np.pi, 100)
F = m.flux(u=[0, 1, 0], theta=theta)
\end{lstlisting}
%
The variable $\textsf{F}$ is
an array of flux values computed from \eq{phaseint}; we plot this in
Figure~\ref{fig:earthphasecurve}, alongside the rotational phase curves due to each of
the seven individual continents.
%
\begin{figure}[ht!]
    \begin{centering}
    \includegraphics[width=\linewidth]{figures/earthphasecurve.pdf}
    \caption{\label{fig:earthphasecurve}
             \python{earthphasecurve}
             Phase curve for the Earth rotating about its axis, computed
             from the $l_\mathrm{max} = 10$ expansion from
             Figure~\ref{fig:earth}. The full rotational phase curve is shown in black,
             and the flux due to each of the seven continents is shown as
             the colored curves (see legend). The black dots correspond to the
             numerical solution.}
    \end{centering}
\end{figure}
%

% ------------------------------------------------------------------------------
\subsection{Computing occultation light curves}
\label{sec:starryoccultation}
% ------------------------------------------------------------------------------

Occultation light curves are similarly easy to compute:
%
\begin{lstlisting}[language=Python,firstnumber=last]
F = m.flux(u=u, theta=theta, xo=xo, yo=yo, ro=ro)
\end{lstlisting}
%
where \textsf{u} and \textsf{theta} are the same as above, and
\textsf{xo}, \textsf{yo}, and \textsf{ro} are the occultor parameters
($\x$ position, $\y$ position, and radius, all in units of the
occulted body's radius), which may be either scalars
or arrays.

%

In the bottom panel of Figure~\ref{fig:ylmlightcurves} we plot
occultation light curves for the spherical harmonics with $m \ge 0$
up to $l_\mathrm{max} = 6$. The occultor has radius $r = 0.3$ and
moves at a constant speed along the $\x$ direction at $y_o = 0.25$
(blue curves) and $y_o = 0.75$ (orange curves). The light curve of
any body undergoing such an occultation can be expressed as a weighted
sum of these light curves. Note that because the value of individual
spherical harmonics can be negative, an increase in the flux is visible
at certain points during the occultation; however, this would of course not
occur for any physical map constructed from a linear combination of
the spherical harmonics. Note also that unlike in the case of rotational phase curves,
there is no null space for occultations, as all spherical harmonics (including
those with $m < 0$, which are not shown) produce a flux signal during
occultation. As before, the numerical solutions are shown as the small dots.

%
\begin{figure}[ht!]
    \begin{centering}
    \includegraphics[width=\linewidth]{figures/earthoccultation.pdf}
    \caption{\label{fig:earthoccultation}
             \python{earthoccultation}
             Occultation light curve for the Moon transiting the
             rotating Earth,
             computed from the $l_\mathrm{max} = 10$ expansion from
             Figure~\ref{fig:earth}. The two largest dips are due
             to the occultations of South America (left) and Africa
             (right). Once again, the black dots correspond to the
             numerical solution.}
    \end{centering}
\end{figure}
%

To further illustrate the code, we return to our spherical harmonic
expansion of the Earth.
Figure~\ref{fig:earthoccultation} shows an occultation light curve
computed for a hypothetical transit of the Earth by the Moon. The
occultation lasts about four hours, during which time
the sub-observer point rotates from Africa to South America, causing a
steady flux decrease as the Pacific Ocean rotates into view. The
occultation is double-dipped: one dip due to the occultation of South
America, and one dip due to the occultation of Africa.

% ------------------------------------------------------------------------------
\subsection{Computing transit light curves}
\label{sec:starrytransits}
% ------------------------------------------------------------------------------

The formalism developed in this paper can easily be extended to the case
of occultations (transits) of limb-darkened stars by noting that any
radially symmetric specific intensity profile can be expressed as a sum
over the $m = 0$ spherical harmonics (see Figure~\ref{fig:ylms}).
%
In particular, the radial intensity profile of a quadratically
limb-darkened star,
%
\begin{align}
    \label{eq:quadraticld}
    I(\upmu) &= 1 - u_1 (1 - \upmu) - u_2 (1 - \upmu)^2
    \quad,
\end{align}
%
where $\upmu = \z = \sqrt{1 - \x^2 - \y^2}$ and $u_1$ and $u_2$ are the
limb darkening coefficients, can be written in terms of spherical harmonics
by re-writing \eq{quadraticld} as
%
\begin{align}
    I(\x, \y) = (1 - u_1 - 2u_2) + (u_1 + 2u_2) \z + u_2 \x^2 + u_2 \y^2
           \quad.
\end{align}
%
Inverting \eq{AOne} to express this polynomial in the basis of spherical harmonics,
we have
%
\begin{align}
    \label{eq:qldylm}
    I(\x, \y) =
            \frac{2\sqrt{\pi}}{3} (3 - 3u_1 + 4u_2) \, Y_{0,0}
          + \frac{2\sqrt{\pi}}{\sqrt{3}} (u_1 + 2u_2) \, Y_{1,0}
          - \frac{4\sqrt{\pi}}{3\sqrt{5}} u_2 \, Y_{2,0}
      \quad.
\mathematica{limbdark}
\end{align}
%
Thus, quadratic limb darkening can be expressed exactly as the sum of the first
three $m = 0$ spherical harmonics. For convenience, this is implemented in
\starry:
%
\begin{lstlisting}[language=Python,firstnumber=last]
m = Map(2)
m.limbdark(u1, u2)
\end{lstlisting}
%
although users may also specify the coefficients in \eq{qldylm} as in
\S\ref{sec:starrymap}.
Figure~\ref{fig:transit} shows a transit light curve computed with \starry
for $u_1 = 0.4, u_2 = 0.26$. The planet/star radius ratio is $r = 0.1$ and
the planet transits at impact parameter $b = 0.5$. For comparison, we also
compute the flux with \batman \citep{Kreidberg2015} and by a
high precision numerical integration of the surface integral of
\eq{quadraticld}. The error on the transit depth for \starry flux is less
than $10^{-5}$ parts per million everywhere in the light curve.
%
\begin{figure}[ht!]
    \begin{centering}
    \includegraphics[width=\linewidth]{figures/transit.pdf}
    \caption{\label{fig:transit}
             \python{transit}
             Sample transit light curve for a planet ($r = 0.1$) transiting a
             quadratically limb-darkened star ($u_1 = 0.4, u_2 = 0.26$). The
             top panel shows the \starry (blue curve) and \batman
             (orange dots) light curves, as well as a light curve generated
             by a high precision direct numerical integration of the surface
             integral (purple dots). The bottom panel shows the fractional
             error on the transit depth in parts per million relative to the
             numerical solution for \starry (blue) and \batman (orange).}
    \end{centering}
\end{figure}
%

% ------------------------------------------------------------------------------
\subsection{Photodynamics}
\label{sec:starryphotodynamics}
% ------------------------------------------------------------------------------

Integrate with \textsf{planetplanet} for easy photodynamics.\todo{todo}


% ------------------------------------------------------------------------------
\subsection{Benchmarks}
\label{sec:starrybenchmarks}
% ------------------------------------------------------------------------------

We validate all our calculations of rotational phase curves and occultation
light curves by comparing them to numerical solutions of the corresponding
surface integrals. We integrate the specific intensity of the body by
discretely summing over its surface map on an adaptive radial mesh whose
resolution is iteratively increased wherever the spatial gradient of the
specific intensity is large and in the vicinity of the limb of the occultor.
\animation{adaptive} Click on the link at right for an animation of our
adaptive mesh scheme.

In \starry, users can request numerical solutions to the flux by typing
%
\begin{lstlisting}[language=Python,firstnumber=last]
F = m.flux(u=u, theta=theta, xo=xo, yo=yo, ro=ro,
           numerical=True, tol=1.e-4)
\end{lstlisting}
%
where \textsf{tol} is the error tolerance, the maximum absolute value of the
difference between the
specific intensity at the center of a grid cell to the average of the specific
intensity at the four vertices of the same cell. The mesh is locally
refined until the requested tolerance is met in all cells.

All light curves in Figure~\ref{fig:ylmlightcurves} show the flux computed
in this way as the small points along each of the curves. We find that our
analytic light curves agree with the numerical solutions to within the error
of the latter.

% ------------------------------------------------------------------------------
\subsection{Speed tests}
\label{sec:starryspeed}
% ------------------------------------------------------------------------------

Discuss the speed tests here (Figures~\ref{fig:speed} and \ref{fig:speed_batman}).
\todo{todo}

\begin{figure}[ht!]
    \begin{centering}
    \includegraphics[width=\linewidth]{figures/speed.pdf}
    \caption{\label{fig:speed}
             \python{speed}
             Speed tests for \starry, showing the light curve evaluation time
             as a function of number of light curve points for rotational
             phase curves (left) and occultation light curves (right) of individual
             spherical harmonics. The top
             panels show the evaluation time for spherical harmonics of different
             degrees $l$, averaged over all orders $m$. The bottom panels
             show the evaluation time for each of the positive orders
             of the $l = 5$ spherical harmonics.
             }
    \end{centering}
\end{figure}

\begin{figure}[ht!]
    \begin{centering}
    \includegraphics[width=0.65\linewidth]{figures/speed_batman.pdf}
    \caption{\label{fig:speed_batman}
             \python{speed}
             Speed comparison to the \batman transit modeling package
             \citep{Kreidberg2015} for a quadratically limb-darkened star.
             }
    \end{centering}
\end{figure}

% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
\section{Conclusions}
\label{sec:conclusions}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

Write an awesome conclusions section.\todo{todo}

%


% ==============================================================================
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
\appendix
\section{Computing the solution vector $\MakeLowercase{s_n}$}
\label{sec:solutionvector}
% ------------------------------------------------------------------------------
% ------------------------------------------------------------------------------
% ==============================================================================

Here we seek a solution to \eq{sn}, which gives the total flux
during an occultation of the $n^\mathrm{th}$ term in the Green's basis
(Equation~\ref{eq:bg}). The primitive integrals $\mathcal{P}$ and
$\mathcal{G}$ in that equation are given by Equations~(\ref{eq:primitiveP})
and (\ref{eq:primitiveQ}), with
$\bvec{G}_n$ defined in \eq{Gn}. Note that all of the terms in \eq{Gn},
with the exception of the $l = 1, m = 0$ case, are simple polynomials
in $\x$, $\y$, and $\z$, which facilitates their integration.
The $l = 1, m = 0$ term (corresponding to the $n = 2$ term in the Green's basis)
is more difficult to integrate, but an analytic
solution exists \citep{Pal2012}. It is, however, more convenient
to note that this term corresponds to a surface map given by the polynomial
$I(x, y) = \tilde{g}_2(x, y) = \sqrt{1 - x^2 - y^2}$, which is the same function used
to model linear limb darkening in stars \citep{MandelAgol2002}. We therefore
evaluate this term separately in Appendix~\ref{sec:linearld} below, followed by
the general term in Appendix~\ref{sec:generalterm}.

% ------------------------------------------------------------------------------
\subsection{Linear limb darkening ($n = 2$)}
\label{sec:linearld}
% ------------------------------------------------------------------------------

From \citet{MandelAgol2002}, the total flux visible during the occultation of a
body whose surface map is given by $I(x, y) = \sqrt{1 - \x^2 -\y^2}$ is
%
\begin{align}
    \label{eq:s2}
    s_2 = \frac{2\pi}{3} \left(1 - \frac{3\Lambda}{2} - \Theta(r - b) \right)
\end{align}
%
where $\Theta(\bigdot)$ is the Heaviside step function and
\todo{rewrite}
%
\begin{align}
    \label{eq:biglam}
    \Lambda &=
    \begin{dcases}
          -\frac{2}{3}\left(1 - r^2\right)^\frac{3}{2}
          & \qquad b = 0
          %
          \\[1.5em]
          \frac{1}{9 \pi \sqrt{b r}} \Bigg[
                (-3 + 12 r^2 - 10 b^2 r^2 - 6 r^4 + \xi) K(k^2)
                &\\
                \phantom{XXXX}
                - 2 \xi E (k^2)
                + 3 \left(\frac{b + r}{b - r}\right) \Pi\left(1-\frac{1}{(b-r)^2}, k^2\right)
                \Bigg]
          & \qquad k^2 < 1
          %
          \\[1.5em]
          %
          \frac{2}{9 \pi \sqrt{(1{-}b{+}r)(1{+}b{-}r)}} \Bigg[
                \left(1 - 5 b^2 + r^2 + (r^2 - b^2)^2\right) K \left(\frac{1}{k^2}\right)
                &\\
                \phantom{XXXXXXXXXXX}
                - 2 \xi k^2 E \left(\frac{1}{k^2}\right)
                &\\
                \phantom{XXXXXXXXXXX}
                + 3 \left(\frac{b + r}{b - r}\right) \Pi\left(\frac{1}{k^2 - \frac{1}{4 b r}}, \frac{1}{k^2}\right)
                \Bigg]
          & \qquad k^2 \ge 1
    \end{dcases}
\end{align}
%
with
%
\begin{align}
    \label{eq:xi}
    \xi &= 2 b r (4 - 7 r^2 - b^2)\\
\intertext{and}
    \label{eq:k2}
    k^2 &= \frac{1 - r^2 - b^2 + 2 b r}{4 b r}
    \quad.
\end{align}
%
In the expressions above, $K(\bigdot)$, $E(\bigdot)$, and $\Pi(\bigdot, \bigdot)$
are the complete elliptic integrals of the first, second kind, and third kind,
respectively, defined as
%
\begin{align}
    \label{eq:elliptic}
    K(k^2) &\equiv \int_0^{\frac{\pi}{2}} \frac{\dd \varphi}{\sqrt{1 - k^2 \sin^2 \varphi}}
    \nonumber \\[0.5em]
    E(k^2) &\equiv \int_0^{\frac{\pi}{2}} \sqrt{1 - k^2 \sin^2 \varphi} \, \dd \varphi
    \nonumber \\[0.5em]
    \Pi(n, k^2) &\equiv \int_0^{\frac{\pi}{2}} \frac{\dd \varphi}{(1 - n \sin^2 \varphi)\sqrt{1 - k^2 \sin^2 \varphi}}
    \quad.
\end{align}

% ------------------------------------------------------------------------------
\subsection{All other terms}
\label{sec:generalterm}
% ------------------------------------------------------------------------------

% ------------------------------------------------------------------------------
\subsubsection{Setting up the equations}
\label{sec:generaltermsetup}
% ------------------------------------------------------------------------------

We evaluate all other terms in $s_n$ by integrating the primitive integrals of
$\bvec{G}_n$. These are given by
%
\begin{align}
    \label{eq:PGn}
    \mathcal{P}(\bvec{G}_n) &=
    \begin{dcases}
        %
        +\int\displaylimits_{\pi - \phi}^{2\pi + \phi}
            (r c_\varphi)^{\frac{\mu+2}{2}}
            (b + r s_\varphi)^{\frac{\nu}{2}}
            r c_\varphi
            \, \dd\varphi
            %
            & \qquad \nu \, \mathrm{even}
        \\[1em]
        %
        -\int\displaylimits_{\pi - \phi}^{2\pi + \phi}
            (r c_\varphi)^{l-2}
            (1 {-} r^2 {-} b^2 {-} 2 b r s_\varphi)^{\frac{3}{2}}
            r s_\varphi
            \, \dd\varphi
            %
            & \qquad \nu \, \mathrm{odd}, \,
                     \mu = 1, \,
                     l \, \mathrm{even}
        \\[1em]
        %
        -\int\displaylimits_{\pi - \phi}^{2\pi + \phi}
            (r c_\varphi)^{l-3}
            (b + r s_\varphi)
            (1 {-} r^2 {-} b^2 {-} 2 b r s_\varphi)^{\frac{3}{2}}
            r s_\varphi
            \, \dd\varphi
            %
            & \qquad \nu \, \mathrm{odd}, \,
                     \mu = 1, \,
                     l \, \mathrm{odd}
        \\[1em]
        %
        +\int\displaylimits_{\pi - \phi}^{2\pi + \phi}
            (r c_\varphi)^{\frac{\mu-3}{2}}
            (b + r s_\varphi)^{\frac{\nu-1}{2}}
            (1 {-} r^2 {-} b^2 {-} 2 b r s_\varphi)^{\frac{3}{2}}
            r c_\varphi
            \, \dd\varphi
            & \qquad \mathrm{otherwise}
    \end{dcases}
%
\intertext{and}
%
    \nonumber \\
    \label{eq:QGn}
    \mathcal{Q}(\bvec{G}_n) &=
    \begin{dcases}
        %
        +\int\displaylimits_{\pi - \lambda}^{2\pi + \lambda}
            c_\varphi^{\frac{\mu+2}{2}}
            s_\varphi^{\frac{\nu}{2}}
            c_\varphi
            \, \dd\varphi
            %
            & \qquad\qquad \nu \, \mathrm{even}
        \\[1em]
        %
        \phantom{XXXXX}0
            & \qquad\qquad \mathrm{otherwise,}
    \end{dcases}
\end{align}
%
%
where we have used the fact that the line integral of any function
proportional to $\z$ taken along the limb of the occulted planet
(where $\z = \sqrt{1-\x^2-\y^2} = 0$) is zero.
%
For convenience, let us introduce the integrals
%
\begin{align}
    \label{eq:Huv}
    \mathcal{H}_{u,v} &=
    \int\displaylimits_{\pi - \lambda}^{2\pi + \lambda}
            c_\varphi^u
            s_\varphi^v
            \, \dd\varphi
%
\\[1.5em]
%
    \label{eq:Iuv}
    \mathcal{I}_{u,v} &=
    \int\displaylimits_{\pi - \phi}^{2\pi + \phi}
            c_\varphi^u
            s_\varphi^v
            \, \dd\varphi
%
\\[1.5em]
%
    \label{eq:Juv}
    \mathcal{J}_{u,v} &=
    \int\displaylimits_{\pi - \phi}^{2\pi + \phi}
        c_\varphi^u
        s_\varphi^v
        (1 - r^2 - b^2 - 2 b r s_\varphi)^{\frac{3}{2}}
        \, \dd\varphi \quad,
\end{align}
%
along with the expressions
%
\begin{align}
    \label{eq:Kuv}
    \mathcal{K}_{u,v} &=
        \sum\displaylimits_{i=0}^{v}
        {v \choose i}
        \left(\frac{b}{r}\right)^{v-i}
        \mathcal{I}_{u, i}
        \quad.
%
\\[1.5em]
%
    \label{eq:Luv}
    \mathcal{L}_{u,v} &=
        \sum\displaylimits_{i=0}^{v}
        {v \choose i}
        \left(\frac{b}{r}\right)^{v-i}
        \mathcal{J}_{u, i}
        \quad.
\end{align}
%
With some algebra, we may therefore write
%
\begin{align}
    \label{eq:PGnI}
    \mathcal{P}(\bvec{G}_n) &=
    \begin{dcases}
        %
        r^{l+2} \mathcal{K}_{\frac{\mu+4}{2}, \frac{\nu}{2}}
            %
            & \qquad \nu \, \mathrm{even}
        \\[1em]
        %
        %b r^{l-2} \mathcal{L}_{l-2, 0}
        %- r^{l-1} \mathcal{L}_{l-2,1}
        -r^{l-1} \mathcal{J}_{l-2, 1}
            %
            & \qquad \nu \, \mathrm{odd}, \,
                     \mu = 1, \,
                     l \, \mathrm{even}
        \\[1em]
        %
        -r^{l-2} \left( b \mathcal{J}_{l-3,1} + r \mathcal{J}_{l-3,2} \right)
        %b r^{l-2} \mathcal{L}_{l-3, 1}
        %- r^{l-1} \mathcal{L}_{l-3,2}
            %
            & \qquad \nu \, \mathrm{odd}, \,
                     \mu = 1, \,
                     l \, \mathrm{odd}
        \\[1em]
        %
        r^{l-1} \mathcal{L}_{\frac{\mu-1}{2}, \frac{\nu-1}{2}}
            & \qquad \mathrm{otherwise}
    \end{dcases}
    \pdf{PGn}
%
\intertext{and}
%
    \nonumber \\
    \label{eq:QGnI}
    \mathcal{Q}(\bvec{G}_n) &=
    \begin{dcases}
        \mathcal{H}_{\frac{\mu+4}{2}, \frac{\nu}{2}}
        & \qquad \qquad \qquad \qquad \quad \quad \quad \quad \nu \, \mathrm{even}
        \\[1em]
        %
        0
        & \qquad \qquad \qquad \qquad \quad \quad \quad \quad \nu \, \mathrm{odd} \quad.
    \end{dcases}
\end{align}
%
The solution to the occultation problem is therefore a matter of finding
expressions for the integrals $\mathcal{H}_{u, v}$,
$\mathcal{I}_{u, v}$, and $\mathcal{J}_{u, v}$.

% ------------------------------------------------------------------------------
\subsubsection{Solving the integrals}
\label{sec:generaltermsol}
% ------------------------------------------------------------------------------

Fortunately, $\mathcal{H}_{u, v}$ and $\mathcal{I}_{u, v}$
evaluate to terms containing
only sines and cosines of $\lambda$ and $\phi$, respectively.
\citet{Pal2012} derived simple recurrence relations
for these terms:
%
\begin{align}
    \label{eq:Huvsol}
    \mathcal{H}_{u,v} &=
    \begin{dcases}
        0
        & \qquad u \ \mathrm{odd}
        %
        \\[0.5em]
        %
        2\lambda + \pi
        & \qquad u = v = 0
        %
        \\[0.5em]
        %
        -2\cos\lambda
        & \qquad u = 0, v = 1
        %
        \\[0.5em]
        %
        \frac{2}{u + v}
        (\cos\lambda)^{u - 1} (\sin\lambda)^{v + 1} +
        \frac{u - 1}{u + v} \mathcal{H}_{u-2,v}
        & \qquad u \ge 2
        %
        \\[0.5em]
        %
        -\frac{2}{u + v}
        (\cos\lambda)^{u + 1} (\sin\lambda)^{v - 1} +
        \frac{v - 1}{u + v} \mathcal{H}_{u,v-2}
        & \qquad v \ge 2
        \quad
        %
    \end{dcases}
    \mathematica{HI}
\end{align}
%
and
%
\begin{align}
    \label{eq:Iuvsol}
    \mathcal{I}_{u,v} &=
    \begin{dcases}
        0
        & \qquad u \ \mathrm{odd}
        %
        \\[0.5em]
        %
        2\phi + \pi
        & \qquad u = v = 0
        %
        \\[0.5em]
        %
        -2\cos\phi
        & \qquad u = 0, v = 1
        %
        \\[0.5em]
        %
        \frac{2}{u + v}
        (\cos\phi)^{u - 1} (\sin\phi)^{v + 1} +
        \frac{u - 1}{u + v} \mathcal{I}_{u-2,v}
        & \qquad u \ge 2
        %
        \\[0.5em]
        %
        -\frac{2}{u + v}
        (\cos\phi)^{u + 1} (\sin\phi)^{v - 1} +
        \frac{v - 1}{u + v} \mathcal{I}_{u,v-2}
        & \qquad v \ge 2
        \quad.
        %
    \end{dcases}
    \mathematica{HI}
\end{align}
%

Conversely, because of the term raised to the $\nicefrac{3}{2}$ power in
\eq{Juv}, $\mathcal{J}_{u,v}$ is significantly more
difficult to compute. With some tedious algebraic manipulation, and using
recurrence relations for expressions with integrands
of the form $\cos^p\varphi\sin^q\varphi (1 - \chi^2 \sin^2 \varphi)^\frac{3}{2}$
\citep{Gradshteyn1994}, we may write
%
\begin{align}
    \label{eq:Juvsol}
    \mathcal{J}_{u,v} &=
        2^{u + 3} (b r)^\frac{3}{2}
        \sum\displaylimits_{i=0}^v
            {v \choose i}\left(-1\right)^{i-v-u}\mathcal{M}_{u + 2i, u + 2v - 2i}
    \mathematica{case2}
\end{align}
%
where
%
\begin{align}
    \label{eq:Mpq}
    \mathcal{M}_{p, q}  &=
    \begin{dcases}
        %
        0 & \qquad p\ \mathrm{odd} \ \mathrm{or} \ q\ \mathrm{odd}\\[0.5em]
        %
        \frac{d_1 \mathcal{M}_{p,q-2} + d_2 \mathcal{M}_{p,q-4}}
             {p + q + 3}
        & \qquad q \ge 4 \\[0.5em]
        %
        \frac{d_3 \mathcal{M}_{p-2,q} + d_4 \mathcal{M}_{p-4,q}}
             {p + q + 3}
         & \qquad p \ge 4
    \end{dcases}
    \mathematica{case2}
\end{align}
%
with
%
\begin{align}
    d_1 &= q + 2 + (p + q - 2)(1 - k^2) \nonumber \\
    d_2 &= (3 - q)(1 - k^2) \nonumber \\
    d_3 &= 2 p + q - (p + q - 2)(1 - k^2) \nonumber \\
    d_4 &= (3 - p) + (p - 3)(1 - k^2)
\end{align}
%
and $k^2$ defined as in \eq{k2}.
%
These recurrence relations require four initial conditions:
%
\begin{align}
    \mathcal{M}_{0,0} &= \frac{8-12k^2}{3}\mathcal{E}_1 + \frac{-8 + 16k^2}{3}\mathcal{E}_2 \nonumber \\[1em]
    \mathcal{M}_{0,2} &= \frac{8-24k^2}{15}\mathcal{E}_1 + \frac{-8 + 28k^2 + 12k^4}{15}\mathcal{E}_2 \nonumber \\[1em]
    \mathcal{M}_{2,0} &= \frac{32 - 36k^2}{15}\mathcal{E}_1 + \frac{-32 + 52k^2 - 12k^4}{15}\mathcal{E}_2 \nonumber \\[1em]
    \mathcal{M}_{2,2} &= \frac{32-60k^2+12k^4}{105}\mathcal{E}_1 + \frac{-32 + 76 k^2 - 36 k^4 + 24 k^6}{105}\mathcal{E}_2
    \quad,
    \mathematica{case2}
\end{align}
%
where we defined the elliptic functions
%
\begin{align}
    \label{eq:E1}
    \mathcal{E}_1 &=
    \begin{dcases}
        (1-k^2) K \left(k^2\right) & \qquad k^2 < 1 \\[0.5em]
        0 & \qquad k^2 = 1 \\[0.5em]
        \frac{1-k^2}{\sqrt{k^2}} K \left(\frac{1}{k^2}\right) & \qquad k^2 \ge 1
    \end{dcases}
    \\[0.5em]
\intertext{and}
    \label{eq:E2}
    \mathcal{E}_2 &=
    \begin{dcases}
        E \left(k^2\right) & \qquad k^2 < 1 \\[0.5em]
        0 & \qquad k^2 = 1 \\[0.5em]
        \sqrt{k^2} E \left(\frac{1}{k^2}\right)
            + \frac{1-k^2}{\sqrt{k^2}} K \left(\frac{1}{k^2}\right)
          & \qquad k^2 \ge 1
          \quad.
    \end{dcases}
    \mathematica{case2}
\end{align}
%
Interestingly, the elliptic integrals in the expressions above are exactly
the same as the ones used to evaluate the $s_2$ term (Equation~\ref{eq:biglam}),
so these need only be evaluated \emph{once} when computing the occultation flux of
a map of arbitrary degree. Thanks to the recurrence relations, all other operations
required to evaluate $\mathcal{J}_{u,v}$ are elementary, making the
computation of $s_n$ fast.

% ------------------------------------------------------------------------------
\subsubsection{Numerical stability}
\label{sec:numericalstability}
% ------------------------------------------------------------------------------

A few remarks are in order regarding the numerical stability of these solutions.
First, the solution for $s_2$ (Equation~\ref{eq:s2}) is unstable when $b = r$ because
the elliptic integral $\Pi$ diverges. Elaborate... \todo{todo}

Second, the expression for $k^2$ (Equation~\ref{eq:k2}) diverges when either $b = 0$
or $r = 0$. Our tests show that the latter case does not introduce significant numerical
error when computing the solution vector $\mathbf{s}$ because of the factors of $r$
multiplying the integrals in \eq{PGnI}. However, in the limit $b \rightarrow 0$,
we find that the expressions for $\mathcal{M}_{p,q}$ (Equation~\ref{eq:Mpq}) are unstable,
leading to large errors in the evaluation of $\mathcal{J}_{u,v}$ (Equation~\ref{eq:Juvsol})
and thus also in $\mathcal{P}(\mathbf{G}_n)$ (Equation~\ref{eq:PGnI}). When $b = 0$, the term in
parentheses in (Equation~\ref{eq:Juv}) vanishes, and we may compute $\mathcal{J}_{u,v}$
directly as
%
\begin{align}
    \mathcal{J}_{u,v}(b = 0) = (1 - r^2)^\frac{3}{2} \mathcal{I}_{u,v} \quad.
    \mathematica{taylorb}
\end{align}
%
In the vicinity of $b = 0$, we can instead Taylor expand the integrand in
\eq{Juv}, obtaining
%
\begin{align}
    \lim_{b\rightarrow 0}\mathcal{J}_{u,v} = \sum\displaylimits_{n = 0} d_n b^n
    \quad,
\end{align}
%
where to fifth order we have
\begin{align}
    d_0 &= (1 - r^2)^\frac{3}{2} \mathcal{I}_{u, v} \nonumber \\[0.5em]
    d_1 &= -3r(1 - r^2)^\frac{1}{2} \mathcal{I}_{u, v + 1} \nonumber \\[0.5em]
    d_2 &= -\frac{3}{2}(1 - r^2)^\frac{1}{2} \mathcal{I}_{u, v}
           + \frac{3}{2}r^2(1 - r^2)^{-\frac{1}{2}} \mathcal{I}_{u, v+2} \nonumber \\[0.5em]
    d_3 &= \frac{3}{2}r(1 - r^2)^{-\frac{1}{2}} \mathcal{I}_{u, v+1}
           + \frac{1}{2}r^3(1 - r^2)^\frac{-3}{2} \mathcal{I}_{u, v+3} \nonumber \\[0.5em]
    d_4 &= \frac{3}{8}(1 - r^2)^{-\frac{1}{2}} \mathcal{I}_{u, v}
           + \frac{3}{4}r^2(1 - r^2)^{-\frac{3}{2}} \mathcal{I}_{u, v+2}
           + \frac{3}{8}r^4(1 - r^2)^{-\frac{5}{2}} \mathcal{I}_{u, v+4} \nonumber \\[0.5em]
    d_5 &= \frac{3}{8}r(1 - r^2)^{-\frac{3}{2}} \mathcal{I}_{u, v + 1}
           + \frac{3}{4}r^3(1 - r^2)^{-\frac{5}{2}} \mathcal{I}_{u, v+3}
           + \frac{3}{8}r^5(1 - r^2)^{-\frac{7}{2}} \mathcal{I}_{u, v+5}
    \quad.
    \mathematica{taylorb}
\end{align}
%
In \starry, we evaluate $\mathcal{J}_{u,v}$ using this Taylor expansion when $b < 0.1$.

More things: \todo{todo}
\begin{itemize}
    \item Numerically unstable for very large occultors. Set usemp flag.
    \item Earth secondary eclipse by Sun, $lmax = 2$.
    \item Figure out the occultor radius at which things go unstable for each order.
\end{itemize}

\bibliography{starry}

%

\clearpage
\begin{center}
\begin{longtable}{cll}
\caption{Symbols used in this paper} \label{tab:symbols} \\
%
\toprule
\multicolumn{1}{c}{\textbf{Symbol}} &
\multicolumn{1}{c}{\textbf{Definition}} &
\multicolumn{1}{c}{\textbf{Reference}} \\
\midrule
\endfirsthead
%
\multicolumn{3}{c}%
{{\bfseries \tablename\ \thetable{} --} continued from previous page} \\
\toprule
\multicolumn{1}{c}{\textbf{Symbol}} &
\multicolumn{1}{c}{\textbf{Definition}} &
\multicolumn{1}{c}{\textbf{Reference}} \\
\midrule
\endhead
\bottomrule
%
\endfoot
%
\bottomrule
\endlastfoot
%
$A_{lm}$        & Legendre function normalization       & \eq{alm} \\
$\bvec{A}$      & Change of basis matrix:
                  $Y_{lm}$s to Green's
                  polynomials                           & \eq{A} \\
$\AOne$         & Change of basis matrix:
                  $Y_{lm}$s to polynomials              & \S\ref{sec:polybasis} \\
$\ATwo$         & Change of basis matrix:
                  polynomials to Green's polynomials    & \S\ref{sec:greensbasis} \\
$b$             & Impact parameter in units of occulted
                  body's radius                         & \S\ref{sec:occultations} \\
$B_{lm}^{jk}$   & Spherical harmonic normalization      & \eq{blmjk} \\

$c_{\bigdot}$   & $\cos(\bigdot)$                       & \\
$C_{pq}^k$      & Expansion coefficient for
                  $\z(\x, \y)$                          & \eq{ckpq} \\
$d$             & Dummy coefficient                     & \\
$\bvec{D}^l$    & Rotation matrix for the
                  complex spherical harmonics
                  of degree $l$                         & \eq{dl} \\
$\bvec{D}\,\wedge$
                & Exterior derivative                   & \eq{extderiv} \\
$E(\bigdot)$    & Complete elliptic integral of the
                  second kind                           & \eq{elliptic} \\
$\mathcal{E}_1$ & First elliptic function               & \eq{E1} \\
$\mathcal{E}_2$ & Second elliptic function              & \eq{E2} \\
$F$             & Total flux seen by observer           & \eq{starry} \\
$\gbasis$       & Green's basis                         & \eq{bg} \\
$\bvec{g}$      & Vector in the basis $\gbasis$         & \\
$\bvec{G}_n$    & Anti-exterior derivative of the
                  $n^\mathrm{th}$
                  term in the Green's basis             & \eq{Gn} \\
$\mathcal{H}_{u,v}$
                & Occultation integral                  & \eq{Huv} \\
$I$             & Specific intensity, $I(\x, \y)$       & \eq{I} \\
$\mathcal{I}_{u,v}$
                & Occultation integral                  & \eq{Iuv} \\
$j$             & Dummy index                           & \\
$\mathcal{J}_{u,v}$
                & Occultation integral                  & \eq{Juv} \\
$k$             & Dummy index                           & \\
$k^2$           & Elliptic parameter                    & \eq{k2} \\
$K(\bigdot)$    & Complete Elliptic integral of the
                  first kind                            & \eq{elliptic} \\
$\mathcal{K}_{u,v}$
                & Occultation integral                  & \eq{Kuv} \\
$l$             & Spherical harmonic degree             & \eq{lm} \\
$\mathcal{L}_{u,v}$
                & Occultation integral                  & \eq{Luv} \\
$m$             & Spherical harmonic order              & \eq{lm} \\
$\mathcal{M}_{p,q}$
                & Occultation integral                  & \eq{Mpq} \\
$n$             & Surface map vector index,
                  $n = l^2 + l + m$                     & \eq{n} \\
$p$             & Dummy index                           & \\
$\bar{P}$       & Normalized associated Legendre
                  function                              & \eq{plm} \\
$\pbasis$       & Polynomial basis                      & \eq{bp} \\
$\bvec{p}$      & Vector in the basis $\pbasis$         & \\
$\bvec{P}$      & Cartesian axis-angle rotation matrix  & \eq{rotP} \\
$\mathcal{P}$   & Primitive integral along perimiter
                  of occultor                           & \eq{primitiveP} \\
$q$             & Dummy index                           & \\
$\bvec{Q}$      & Cartesian Euler angle rotation matrix & \eq{rotQ} \\
$\mathcal{Q}$   & Primitive integral along perimiter
                  of occulted body                      & \eq{primitiveQ} \\
$r$             & Occultor radius in units of occulted
                  body's radius                         & \S\ref{sec:occultations} \\
$\bvec{r}$      & Phase curve solution vector           & \eq{rn} \\
$\bvec{R}$      & Rotation matrix for the real
                  spherical harmonics                   & \eq{rblockdiag} \\
$\bvec{R}^l$    & Rotation matrix for the real
                  spherical harmonics of degree $l$     & \eq{rl} \\
$s_{\bigdot}$   & $\sin(\bigdot)$                       & \\
$\bvec{s}$      & Occultation light curve solution
                  vector                                & \eq{rn} \\
$u_1, u_2$      & Quadratic limb darkening coefficients & \eq{quadraticld} \\
$\bvec{u}$      & Unit vector corresponding to the
                  axis of rotation                      & \S\ref{sec:axisangle} \\
$\bvec{U}$      & Complex to real spherical harmonics
                  transform matrix                      & \eq{U} \\
$\x$            & Cartesian coordinate                  & \eq{xyz} \\
$\y$            & Cartesian coordinate                  & \eq{xyz} \\
$Y_{l,m}$       & Spherical harmonic of degree $l$
                  and order $m$                         & \eq{ylm0} \\
$\ybasis$       & Spherical harmonic basis              & \eq{by} \\
$\bvec{y}$      & Vector in the basis $\ybasis$         & \\
$\z$            & Cartesian coordinate,
                  $z = \sqrt{1 - \x^2 - \y^2}$          & \eq{xyz} \\
%
$\alpha$        & Euler angle ($\zhat$ rotation)        & \S\ref{sec:euler} \\
$\beta$         & Euler angle ($\yhat$ rotation)        & \S\ref{sec:euler} \\
$\gamma$        & Euler angle ($\zhat$ rotation)        & \S\ref{sec:euler} \\
$\Gamma$        & Gamma function                        & \\
$\theta$        & Polar angle                           & \eq{ylmtp} \\
                & Spherical harmonic rotation angle     & \S\ref{sec:axisangle} \\
$\Theta$        & Heaviside step function               & \eq{biglam} \\
$\lambda$       & Angular position of
                  occultor/occulted intersection point  & \eq{lambda} \\
$\Lambda$       & \citet{MandelAgol2002} function       & \eq{biglam} \\
$\mu$           & $l - m$                               & \eq{munu} \\
$\upmu$         & Limb darkening radial parameter       & \eq{quadraticld} \\
$\nu$           & $l + m$                               & \eq{munu} \\
$\xi$           & Function of $b$ and $r$               & \ref{eq:k2} \\
$\Pi(\bigdot,\bigdot)$
                & Complete elliptic integral of the
                  third kind                            & \eq{elliptic} \\
$\phi$          & Spherical harmonic azimuthal angle    & \eq{ylmtp} \\
                & Angular position of
                  occultor/occulted intersection point  & \eq{phi} \\
$\varphi$       & Dummy integration variable            & \\
$\omega$        & Angular position of occultor          & \eq{zrot}
%
\end{longtable}
\end{center}

\end{document}
